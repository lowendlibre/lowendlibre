From 84a910700c9415d7b0ea168eb6f6122fc68b27c5 Mon Sep 17 00:00:00 2001
From: JustSoup321 <brandonboese@protonmail.com>
Date: Tue, 11 Jul 2023 15:51:53 -0400
Subject: [PATCH 2/2] Modify frontend flashing abilities in config init.py to
 support mtkclient.

---
 ...Modify-flasher-init.py-for-mtkclient.patch | 27 +++++++++++++++++++
 pmb/config/__init__.py                        | 21 +++++++++++++++
 2 files changed, 48 insertions(+)
 create mode 100644 0001-Modify-flasher-init.py-for-mtkclient.patch

diff --git a/0001-Modify-flasher-init.py-for-mtkclient.patch b/0001-Modify-flasher-init.py-for-mtkclient.patch
new file mode 100644
index 00000000..3e46bae3
--- /dev/null
+++ b/0001-Modify-flasher-init.py-for-mtkclient.patch
@@ -0,0 +1,27 @@
+From d57d81e95e96333eb4eb7b8ad3595fa1a180df1f Mon Sep 17 00:00:00 2001
+From: Brandon Boese <brandonboese@protonmail.com>
+Date: Tue, 11 Jul 2023 15:29:18 -0400
+Subject: [PATCH] Modify flasher init.py for mtkclient.
+
+---
+ pmb/flasher/init.py | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+diff --git a/pmb/flasher/init.py b/pmb/flasher/init.py
+index aff7808d..1e2c716b 100644
+--- a/pmb/flasher/init.py
++++ b/pmb/flasher/init.py
+@@ -32,6 +32,10 @@ def install_depends(args):
+         pmaports_cfg = pmb.config.pmaports.read_config(args)
+         depends = pmaports_cfg.get("supported_heimdall_depends",
+                                    "heimdall,avbtool").split(",")
++    elif method == "mtkclient":
++        pmaports_cfg = pmb.config.pmaports.read_config(args)
++        depends = pmaports_cfg.get("supported_mtkclient_depends",
++                                   "mtkclient,avbtool").split(",")
+ 
+     pmb.chroot.apk.install(args, depends)
+ 
+-- 
+2.41.0
+
diff --git a/pmb/config/__init__.py b/pmb/config/__init__.py
index 85e2f753..386f54bd 100644
--- a/pmb/config/__init__.py
+++ b/pmb/config/__init__.py
@@ -884,6 +884,7 @@ flash_methods = [
     "none",
     "rkdeveloptool",
     "uuu",
+    "mtkclient",
 ]
 
 # These folders will be mounted at the same location into the native
@@ -1032,6 +1033,26 @@ flashers = {
             ],
         },
     }
+    "mtkclient": {
+        "depends": ["mtkclient"]
+        "actions": {
+            "flash_rootfs": [["mtk", "w", "$PARTITION_ROOTFS",
+                              "$IMAGE"]],
+            "flash_kernel": [["mtk", "w", "$PARTITION_KERNEL",
+                              "$BOOT/boot.img$FLAVOR"]],
+            "flash_vbmeta": [
+                # Generate vbmeta image with "disable verification" flag
+                ["avbtool", "make_vbmeta_image", "--flags", "2",
+                    "--padding_size", "$FLASH_PAGESIZE",
+                    "--output", "/vbmeta.img"],
+                ["mtk", "w", "$PARTITION_VBMETA", "/vbmeta.img"],
+                ["rm", "-f", "/vbmeta.img"]
+            ],
+            "flash_dtbo": [["mtk", "w", "$PARTITION_DTBO",
+                            "$BOOT/dtbo.img"]],
+            "flash_lk2nd": [["mtk", "w", "$PARTITION_KERNEL",
+                             "$BOOT/lk2nd.img"]]
+    }
 }
 
 #
-- 
2.41.0

